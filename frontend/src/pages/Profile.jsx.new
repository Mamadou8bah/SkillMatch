import React, { useState, useEffect } from 'react';
import '../styles/Profile.css';
import { useNavigate } from 'react-router-dom';
import {
  Settings,
  LogOut,
  ChevronRight,
  Globe,
  Bell,
  HelpCircle,
  Briefcase,
  Award,
  Plus,
  X,
  Moon,
  Volume2,
  Trash2
} from 'lucide-react';

export const Profile = () => {
  const navigate = useNavigate();
  const [activeView, setActiveView] = useState('main'); 
  const [isLoading, setIsLoading] = useState(true);

  const [profileData, setProfileData] = useState({
    fullName: "",
    email: "",
    role: "",
    location: "",
    mobile: ""
  });

  const [skills, setSkills] = useState([]);
  const [newSkill, setNewSkill] = useState('');

  const [experiences, setExperiences] = useState([]);
  const [newExperience, setNewExperience] = useState({
    companyName: '',
    jobTitle: '',
    startDate: '',
    endDate: '',
    description: ''
  });

  const [showAddForm, setShowAddForm] = useState(false);

  const userId = localStorage.getItem('userId');
  const token = localStorage.getItem('token');

  useEffect(() => {
    if (userId) {
      fetchUserProfile();
      fetchSkills();
      fetchExperiences();
    }
  }, [userId]);

  const fetchUserProfile = async () => {
    try {
      const response = await fetch(`/api/users/${userId}`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      const data = await response.json();
      if (data.success) {
        setProfileData({
          fullName: data.data.fullName || '',
          email: data.data.email || '',
          role: data.data.role || '',
          location: data.data.location || '',
          mobile: data.data.mobile || ''
        });
      }
    } catch (error) {
      console.error('Error fetching profile:', error);
    } finally {
      setIsLoading(false);
    }
  };

  const fetchSkills = async () => {
    try {
      const response = await fetch(`/api/skill/user/${userId}`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      const data = await response.json();
      if (data.success) {
        setSkills(data.data || []);
      }
    } catch (e) {
      console.error(e);
    }
  };

  const fetchExperiences = async () => {
    try {
      const response = await fetch(`/api/experience/user/${userId}`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      const data = await response.json();
      if (data.success) {
        setExperiences(data.data || []);
      }
    } catch (e) {
      console.error(e);
    }
  };

  const handleInputChange = (e) => {
    const { name, value } = e.target;
    setProfileData(prev => ({ ...prev, [name]: value }));
  };

  const handleSaveProfile = async () => {
    try {
      const response = await fetch(`/api/users/${userId}`, {
        method: 'PUT',
        headers: { 
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify(profileData)
      });
      const data = await response.json();
      if (data.success) {
        setActiveView('main');
      }
    } catch (error) {
      console.error('Error saving profile:', error);
    }
  };

  const handleAddSkill = async () => {
    if (newSkill.trim()) {
      try {
        const response = await fetch('/api/skill', {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ title: newSkill.trim() })
        });
        const data = await response.json();
        if (data.success) {
          setSkills([...skills, data.data]);
          setNewSkill('');
        }
      } catch (e) {
        console.error(e);
      }
    }
  };

  const handleRemoveSkill = async (id) => {
    try {
      const response = await fetch(`/api/skill/${id}`, {
        method: 'DELETE',
        headers: { 'Authorization': `Bearer ${token}` }
      });
      const data = await response.json();
      if (data.success) {
        setSkills(skills.filter(s => s.id !== id));
      }
    } catch (e) {
      console.error(e);
    }
  };

  const handleAddExperience = async () => {
    try {
      const response = await fetch('/api/experience', {
        method: 'POST',
        headers: { 
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify(newExperience)
      });
      const data = await response.json();
      if (data.success) {
        setExperiences([...experiences, data.data]);
        setNewExperience({
          companyName: '',
          jobTitle: '',
          startDate: '',
          endDate: '',
          description: ''
        });
        setShowAddForm(false);
      }
    } catch (e) {
      console.error(e);
    }
  };

  const handleDeleteExperience = async (id) => {
    try {
      const response = await fetch(`/api/experience/${id}`, {
        method: 'DELETE',
        headers: { 'Authorization': `Bearer ${token}` }
      });
      const data = await response.json();
      if (data.success) {
        setExperiences(experiences.filter(exp => exp.id !== id));
      }
    } catch (e) {
      console.error(e);
    }
  };

  const handleLogout = () => {
    localStorage.clear();
    navigate('/');
  };

  // VIEWS (Simplified for brevity but keeping all relevant sections)
  const renderBackBtn = () => (
    <button className="back-btn" onClick={() => { setActiveView('main'); setShowAddForm(false); }}>
      <svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" fill="currentColor" width="24px" height="24px">
        <path fill="currentColor" d="M224 480h640a32 32 0 1 1 0 64H224a32 32 0 0 1 0-64z"></path>
        <path fill="currentColor" d="m237.248 512 265.408 265.344a32 32 0 0 1-45.312 45.312l-288-288a32 32 0 0 1 0-45.312l288-288a32 32 0 1 1 45.312 45.312L237.248 512z"></path>
      </svg>
    </button>
  );

  if (activeView === 'edit') {
    return (
      <div className="profile-container sub-view">
        <div className="edit-header">
          {renderBackBtn()}
          <h2>Edit Profile</h2>
          <div className="spacer"></div>
        </div>
        <div className="edit-form">
          <div className="form-group">
            <label>Full Name</label>
            <input type="text" name="fullName" value={profileData.fullName} onChange={handleInputChange} className="form-input" />
          </div>
          <div className="form-group">
            <label>Location</label>
            <input type="text" name="location" value={profileData.location} onChange={handleInputChange} className="form-input" />
          </div>
          <div className="form-group">
            <label>Mobile</label>
            <input type="text" name="mobile" value={profileData.mobile} onChange={handleInputChange} className="form-input" />
          </div>
          <button className="save-btn" onClick={handleSaveProfile}>Save Changes</button>
        </div>
      </div>
    );
  }

  if (activeView === 'skills') {
    return (
      <div className="profile-container sub-view">
        <div className="edit-header">
          {renderBackBtn()}
          <h2>Skills</h2>
          <div className="spacer"></div>
        </div>
        <div className="skills-view-container">
          <div className="add-skill-box">
            <input type="text" value={newSkill} onChange={(e) => setNewSkill(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && handleAddSkill()} className="form-input" />
            <button className="add-skill-btn" onClick={handleAddSkill}><Plus size={20} /></button>
          </div>
          <div className="skills-list-full">
            {skills.map((skill) => (
              <div key={skill.id} className="skill-chip">
                <span>{skill.title}</span>
                <button onClick={() => handleRemoveSkill(skill.id)} className="remove-skill-btn"><X size={14} /></button>
              </div>
            ))}
          </div>
        </div>
      </div>
    );
  }

  if (activeView === 'experience') {
    return (
      <div className="profile-container sub-view">
        <div className="edit-header">
          {renderBackBtn()}
          <h2>Experience</h2>
          <button className="add-btn" onClick={() => setShowAddForm(true)}><Plus size={20} /></button>
        </div>
        {showAddForm && (
          <div className="add-experience-form">
            <div className="form-grid">
              <input type="text" placeholder="Company Name" value={newExperience.companyName} onChange={(e) => setNewExperience({...newExperience, companyName: e.target.value})} className="form-input" />
              <input type="text" placeholder="Job Title" value={newExperience.jobTitle} onChange={(e) => setNewExperience({...newExperience, jobTitle: e.target.value})} className="form-input" />
              <input type="date" value={newExperience.startDate} onChange={(e) => setNewExperience({...newExperience, startDate: e.target.value})} className="form-input" />
              <input type="date" value={newExperience.endDate} onChange={(e) => setNewExperience({...newExperience, endDate: e.target.value})} className="form-input" />
            </div>
            <textarea placeholder="Description" value={newExperience.description} onChange={(e) => setNewExperience({...newExperience, description: e.target.value})} className="form-input" />
            <div className="form-actions">
              <button className="cancel-btn" onClick={() => setShowAddForm(false)}>Cancel</button>
              <button className="save-experience-btn" onClick={handleAddExperience}>Add Experience</button>
            </div>
          </div>
        )}
        <div className="experience-list">
          {experiences.map(exp => (
            <div key={exp.id} className="experience-card">
              <div className="exp-card-header">
                <h3>{exp.jobTitle} at {exp.companyName}</h3>
                <button onClick={() => handleDeleteExperience(exp.id)} className="delete-exp-btn"><Trash2 size={18} /></button>
              </div>
              <p className="exp-dates">{exp.startDate} - {exp.endDate || 'Present'}</p>
              <p>{exp.description}</p>
            </div>
          ))}
        </div>
      </div>
    );
  }

  // --- Main Profile View ---
  return (
    <div className="profile-container">
      <div className="profile-header">
        <h1>Profile</h1>
        <button className="logout-btn" onClick={handleLogout}><LogOut size={20} /></button>
      </div>

      <div className="profile-card">
        <div className="profile-avatar-container">
          <div className="profile-avatar-placeholder">{profileData.fullName?.charAt(0)}</div>
        </div>
        <div className="profile-info">
          <h2>{profileData.fullName}</h2>
          <p className="profile-role">{profileData.role}</p>
          <div className="profile-location">
            <Globe size={14} />
            <span>{profileData.location || "Earth"}</span>
          </div>
        </div>
        <button className="edit-profile-btn" onClick={() => setActiveView('edit')}>Edit Profile</button>
      </div>

      <div className="profile-stats">
        <div className="stat-item" onClick={() => setActiveView('skills')}>
          <Award size={20} />
          <span>{skills.length} Skills</span>
        </div>
        <div className="stat-item" onClick={() => setActiveView('experience')}>
          <Briefcase size={20} />
          <span>{experiences.length} Experiences</span>
        </div>
      </div>

      <div className="profile-sections">
        <div className="section-item" onClick={() => navigate('/notifications')}>
          <div className="section-left">
            <Bell size={20} />
            <span>Notifications</span>
          </div>
          <ChevronRight size={20} />
        </div>
        <div className="section-item">
          <div className="section-left">
            <Settings size={20} />
            <span>Settings</span>
          </div>
          <ChevronRight size={20} />
        </div>
      </div>
    </div>
  );
};
